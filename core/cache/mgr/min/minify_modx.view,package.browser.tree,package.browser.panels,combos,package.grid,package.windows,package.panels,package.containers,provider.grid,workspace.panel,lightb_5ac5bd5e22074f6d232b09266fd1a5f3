MODx.DataView=function(config){config=config||{};this._loadStore(config);Ext.applyIf(config.listeners||{},{'loadexception':{fn:this.onLoadException,scope:this},'beforeselect':{fn:function(view){return view.store.getRange().length>0;}},'contextmenu':{fn:this._showContextMenu,scope:this}});Ext.applyIf(config,{store:this.store,singleSelect:true,overClass:'x-view-over',emptyText:'<div style="padding:10px;">'+_('file_err_filter')+'</div>',closeAction:'hide'});MODx.DataView.superclass.constructor.call(this,config);this.config=config;this.cm=new Ext.menu.Menu();};Ext.extend(MODx.DataView,Ext.DataView,{lookup:{},onLoadException:function(){this.getEl().update('<div style="padding:10px;">'+_('data_err_load')+'</div>');},_addContextMenuItem:function(items){var a=items,l=a.length;for(var i=0;i<l;i=i+1){var options=a[i];if(options==='-'){this.cm.add('-');continue;}
var h=Ext.emptyFn;if(options.handler){h=eval(options.handler);}else{h=function(itm,e){var o=itm.options;var id=this.cm.activeNode.id.split('_');id=id[1];var w=Ext.get('modx_content');if(o.confirm){Ext.Msg.confirm('',o.confirm,function(e){if(e==='yes'){var a=Ext.urlEncode(o.params||{action:o.action});var s='?id='+id+'&'+a;if(w===null){location.href=s;}else{w.dom.src=s;}}},this);}else{var a=Ext.urlEncode(o.params);var s='?id='+id+'&'+a;if(w===null){location.href=s;}else{w.dom.src=s;}}};}
this.cm.add({id:options.id,text:options.text,scope:this,options:options,handler:h});}},_loadStore:function(config){this.store=new Ext.data.JsonStore({url:config.url,baseParams:config.baseParams||{action:'browser/directory/getList',wctx:config.wctx||MODx.ctx,dir:config.openTo||'',source:config.source||0},root:config.root||'results',fields:config.fields,totalProperty:'total',listeners:{'load':{fn:function(){this.select(0);},scope:this,single:true}}});this.store.load();},_showContextMenu:function(v,i,n,e){e.preventDefault();var data=this.lookup[n.id];var m=this.cm;m.removeAll();if(data.menu){this._addContextMenuItem(data.menu);m.show(n,'tl-c?');}
m.activeNode=n;}});Ext.reg('modx-dataview',MODx.DataView);Ext.namespace('MODx.browser');MODx.Browser=function(config){if(MODx.browserOpen&&!config.multiple)return false;if(!config.multiple)MODx.browserOpen=true;config=config||{};Ext.applyIf(config,{onSelect:function(data){},scope:this,source:config.source||1,cls:'modx-browser',closeAction:'hide'});MODx.Browser.superclass.constructor.call(this,config);this.config=config;this.win=new MODx.browser.Window(config);this.win.reset();};Ext.extend(MODx.Browser,Ext.Component,{show:function(el){if(this.win){this.win.show(el);}},hide:function(){if(this.win){this.win.hide();}},setSource:function(source){this.config.source=source;this.win.tree.config.baseParams.source=source;this.win.view.config.baseParams.source=source;}});Ext.reg('modx-browser',MODx.Browser);MODx.browser.Window=function(config){config=config||{};this.ident=Ext.id();this.view=MODx.load({xtype:'modx-browser-view',onSelect:{fn:this.onSelect,scope:this},source:config.source||MODx.config.default_media_source,allowedFileTypes:config.allowedFileTypes||'',wctx:config.wctx||'web',openTo:config.openTo||'',ident:this.ident,id:this.ident+'-view'});this.tree=MODx.load({xtype:'modx-tree-directory',onUpload:function(){this.view.run();},scope:this,source:config.source||MODx.config.default_media_source,hideFiles:config.hideFiles||false,openTo:config.openTo||'',ident:this.ident,rootId:config.rootId||'/',rootName:_('files'),rootVisible:config.rootVisible==undefined||!Ext.isEmpty(config.rootId),id:this.ident+'-tree',hideSourceCombo:config.hideSourceCombo||false,useDefaultToolbar:false,listeners:{'afterUpload':{fn:function(){this.view.run();},scope:this},'changeSource':{fn:function(s){this.config.source=s;this.view.config.source=s;this.view.baseParams.source=s;this.view.dir='/';this.view.run();},scope:this},'nodeclick':{fn:function(n,e){n.select();e.preventDefault();e.stopPropagation();return false;},scope:this},afterrender:{fn:function(tree){tree.root.expand();},scope:this}}});this.tree.on('click',function(node,e){this.load(node.id);},this);Ext.applyIf(config,{title:_('modx_browser')+' ('+(MODx.ctx?MODx.ctx:'web')+')',cls:'modx-browser-win',layout:'border',minWidth:500,minHeight:300,width:'90%',height:Ext.getBody().getViewSize().height*0.9,modal:false,closeAction:'hide',border:false,items:[{id:this.ident+'-browser-tree',cls:'modx-browser-tree',region:'west',width:250,height:'100%',items:this.tree,autoScroll:true,split:true,border:false},{id:this.ident+'-browser-view',cls:'modx-browser-view-ct',region:'center',autoScroll:true,border:false,items:this.view,tbar:this.getToolbar()},{id:this.ident+'-img-detail-panel',cls:'modx-browser-details-ct',region:'east',split:true,border:false,width:250}],buttons:[{id:this.ident+'-cancel-btn',text:_('cancel'),handler:this.close,scope:this},{id:this.ident+'-ok-btn',text:_('ok'),cls:'primary-button',handler:this.onSelect,scope:this}],keys:{key:27,handler:this.hide,scope:this}});MODx.browser.Window.superclass.constructor.call(this,config);this.config=config;this.addEvents({'select':true});};Ext.extend(MODx.browser.Window,Ext.Window,{returnEl:null,filter:function(){var filter=Ext.getCmp(this.ident+'filter');this.view.store.filter('name',filter.getValue(),true);this.view.select(0);},setReturn:function(el){this.returnEl=el;},load:function(dir){dir=dir||(Ext.isEmpty(this.config.openTo)?'':this.config.openTo);this.view.run({dir:dir,source:this.config.source,allowedFileTypes:this.config.allowedFileTypes||'',wctx:this.config.wctx||'web'});this.sortStore();},sortStore:function(){var v=Ext.getCmp(this.ident+'sortSelect').getValue();this.view.store.sort(v,v=='name'?'ASC':'DESC');this.view.select(0);},changeViewmode:function(){var v=Ext.getCmp(this.ident+'viewSelect').getValue();this.view.setTemplate(v);this.view.select(0);},reset:function(){if(this.rendered){Ext.getCmp(this.ident+'filter').reset();this.view.getEl().dom.scrollTop=0;}
this.view.store.clearFilter();this.view.select(0);},getToolbar:function(){return[{text:_('filter')+':',xtype:'label'},{xtype:'textfield',id:this.ident+'filter',selectOnFocus:true,width:200,listeners:{'render':{fn:function(){Ext.getCmp(this.ident+'filter').getEl().on('keyup',function(){this.filter();},this,{buffer:500});},scope:this}}},{text:_('sort_by')+':',xtype:'label'},{id:this.ident+'sortSelect',xtype:'combo',typeAhead:true,triggerAction:'all',width:100,editable:false,mode:'local',displayField:'desc',valueField:'name',lazyInit:false,value:MODx.config.modx_browser_default_sort||'name',store:new Ext.data.SimpleStore({fields:['name','desc'],data:[['name',_('name')],['size',_('file_size')],['lastmod',_('last_modified')]]}),listeners:{'select':{fn:this.sortStore,scope:this}}},'-',{text:_('files_viewmode')+':',xtype:'label'},'-',{id:this.ident+'viewSelect',xtype:'combo',typeAhead:false,triggerAction:'all',width:100,editable:false,mode:'local',displayField:'desc',valueField:'type',lazyInit:false,value:MODx.config.modx_browser_default_viewmode||'grid',store:new Ext.data.SimpleStore({fields:['type','desc'],data:[['grid',_('files_viewmode_grid')],['list',_('files_viewmode_list')]]}),listeners:{'select':{fn:this.changeViewmode,scope:this}}}];},onSelect:function(data){var selNode=this.view.getSelectedNodes()[0];var callback=this.config.onSelect||this.onSelectHandler;var lookup=this.view.lookup;var scope=this.config.scope;this.hide(this.config.animEl||null,function(){if(selNode&&callback){var data=lookup[selNode.id];Ext.callback(callback,scope||this,[data]);this.fireEvent('select',data);}},scope);},onSelectHandler:function(data){Ext.get(this.returnEl).dom.value=unescape(data.url);}});Ext.reg('modx-browser-window',MODx.browser.Window);MODx.browser.View=function(config){config=config||{};this.ident=config.ident+'-view'||'modx-browser-'+Ext.id()+'-view';this._initTemplates();Ext.applyIf(config,{url:MODx.config.connector_url,id:this.ident,fields:[{name:'name',sortType:Ext.data.SortTypes.asUCString},'cls','url','relativeUrl','fullRelativeUrl','image','image_width','image_height','thumb','thumb_width','thumb_height','pathname','ext','disabled','preview',{name:'size',type:'float'},{name:'lastmod',type:'date',dateFormat:'timestamp'},'menu'],baseParams:{action:'browser/directory/getfiles',prependPath:config.prependPath||null,prependUrl:config.prependUrl||null,source:config.source||1,allowedFileTypes:config.allowedFileTypes||'',wctx:config.wctx||'web',dir:config.openTo||''},tpl:MODx.config.modx_browser_default_viewmode==='list'?this.templates.list:this.templates.thumb,itemSelector:MODx.config.modx_browser_default_viewmode==='list'?'div.modx-browser-list-item':'div.modx-browser-thumb-wrap',listeners:{'selectionchange':{fn:this.showDetails,scope:this,buffer:100},'dblclick':config.onSelect||{fn:Ext.emptyFn,scope:this},'render':{fn:this.sortStore,scope:this}},prepareData:this.formatData.createDelegate(this)});MODx.browser.View.superclass.constructor.call(this,config);};Ext.extend(MODx.browser.View,MODx.DataView,{templates:{},removeFile:function(item,e){var node=this.cm.activeNode;var data=this.lookup[node.id];var d='';if(typeof(this.dir)!='object'&&typeof(this.dir)!='undefined'){d=this.dir;}
MODx.msg.confirm({text:_('file_remove_confirm'),url:MODx.config.connector_url,params:{action:'browser/file/remove',file:d+'/'+node.id,source:this.config.source,wctx:this.config.wctx||'web'},listeners:{'success':{fn:function(r){this.run();},scope:this}}});},run:function(p){p=p||{};if(p.dir){this.dir=p.dir;}
Ext.applyIf(p,{action:'browser/directory/getFiles',dir:this.dir,source:this.config.source||MODx.config.default_media_source});this.store.load({params:p,callback:function(){this.refresh();this.select(0);},scope:this});},setTemplate:function(tpl){if(tpl==='list'){this.tpl=this.templates.list;this.itemSelector='div.modx-browser-list-item';}else{this.tpl=this.templates.thumb;this.itemSelector='div.modx-browser-thumb-wrap';}
this.refresh();this.select(0);},sortStore:function(){var v=MODx.config.modx_browser_default_sort||'name'
this.store.sort(v,v=='name'?'ASC':'DESC');this.select(0);},showDetails:function(){var selNode=this.getSelectedNodes();var detailEl=Ext.getCmp(this.config.ident+'-img-detail-panel').body;var okBtn=Ext.getCmp(this.ident+'-ok-btn');if(selNode&&selNode.length>0){selNode=selNode[0];if(okBtn){okBtn.enable();}
var data=this.lookup[selNode.id];detailEl.hide();this.templates.details.overwrite(detailEl,data);detailEl.slideIn('l',{stopFx:true,duration:'.2'});}else{if(okBtn){okBtn.disable();}
detailEl.update('');}},formatData:function(data){var formatSize=function(size){if(size<1024){return size+" bytes";}else{return(Math.round(((size*10)/1024))/10)+" KB";}};data.shortName=Ext.util.Format.ellipsis(data.name,18);data.sizeString=data.size!=0?formatSize(data.size):0;data.imageSizeString=data.preview!=0?data.image_width+"x"+data.image_height+"px":0;data.dateString=!Ext.isEmpty(data.lastmod)?new Date(data.lastmod).format(MODx.config.manager_date_format+" "+MODx.config.manager_time_format):0;this.lookup[data.name]=data;return data;},_initTemplates:function(){this.templates.thumb=new Ext.XTemplate('<tpl for=".">','<div class="modx-browser-thumb-wrap" id="{name}" title="{name}">','  <div class="modx-browser-thumb">','      <img src="{thumb}" title="{name}" />','  </div>','  <span>{shortName}</span>','</div>','</tpl>');this.templates.thumb.compile();this.templates.list=new Ext.XTemplate('<tpl for=".">','<div class="modx-browser-list-item" id="{name}">','  <span class="icon icon-file {cls}">','      <span class="file-name">{name}</span>','      <tpl if="sizeString !== 0">','      <span class="file-size">{sizeString}</span>','      </tpl>','      <tpl if="imageSizeString !== 0">','      <span class="image-size">{imageSizeString}</span>','      </tpl>','  </span>','</div>','</tpl>');this.templates.list.compile();this.templates.details=new Ext.XTemplate('<div class="details">','  <tpl for=".">','  <div class="modx-browser-detail-thumb">','      <img src="{image}" alt="" onclick="Ext.getCmp(\''+this.ident+'\').showFullView(\'{name}\',\''+this.ident+'\'); return false;" />','  </div>','  <div class="modx-browser-details-info">','      <b>'+_('file_name')+':</b>','      <span>{name}</span>','  <tpl if="sizeString !== 0">','      <b>'+_('file_size')+':</b>','      <span>{sizeString}</span>','  </tpl>','  <tpl if="imageSizeString !== 0">','      <b>'+_('image_size')+':</b>','      <span>{imageSizeString}</span>','  </tpl>','  <tpl if="dateString !== 0">','      <b>'+_('last_modified')+':</b>','      <span>{dateString}</span>','  </tpl>','  </div>','  </tpl>','</div>');this.templates.details.compile();},showFullView:function(name,ident){var data=this.lookup[name];if(!data)return;if(!this.fvWin){this.fvWin=new Ext.Window({layout:'fit',width:600,height:450,closeAction:'hide',plain:true,items:[{id:this.ident+'modx-view-item-full',cls:'modx-browser-fullview',html:''}],buttons:[{text:_('close'),handler:function(){this.fvWin.hide();},scope:this}]});}
this.fvWin.show();var w=data.image_width<250?250:(data.image_width>800?800:data.image_width);var h=data.image_height<200?200:(data.image_height>600?600:data.image_width);this.fvWin.setSize(w,h);this.fvWin.center();this.fvWin.setTitle(data.name);Ext.get(this.ident+'modx-view-item-full').update('<img src="'+data.image+'" alt="" class="modx-browser-fullview-img" onclick="Ext.getCmp(\''+ident+'\').fvWin.hide();" />');}});Ext.reg('modx-browser-view',MODx.browser.View);;MODx.tree.PackageBrowserTree=function(config){config=config||{};Ext.applyIf(config,{url:MODx.config.connector_url,action:'workspace/packages/rest/getNodes',baseParams:{provider:MODx.provider},loaderConfig:{preloadChildren:false},stateful:false,rootVisible:false,enableDD:false,autoHeight:true,singleExpand:true,root:{text:_('provider'),nodeType:'async',id:'modx-package-browser-tree-root'},tbar:[{xtype:'textfield',emptyText:_('search'),name:'search',id:'package-browser-search-fld',cls:'icon-search',hideMode:'offsets',width:249,listeners:{change:this.search,specialkey:function(form,e){if(e.getKey()==Ext.EventObject.ENTER){form.blur();}},scope:this}}]});MODx.tree.PackageBrowserTree.superclass.constructor.call(this,config);this.on('click',this.onNodeClick,this);this.on('beforeload',this.onBeforeLoad,this);};Ext.extend(MODx.tree.PackageBrowserTree,MODx.tree.Tree,{initEvents:function(){MODx.tree.PackageBrowserTree.superclass.initEvents.call(this);this.getRootNode().expand();this.getProviderInfos(MODx.provider);},onLoad:function(ldr,node,resp){var r=Ext.decode(resp.responseText);if(r.message){MODx.msg.alert(_('error'),r.message,function(){location.href=location.href;});return false;}},changeGProvider:false,changePProvider:false,getProviderInfos:function(pv){MODx.Ajax.request({url:this.config.url,params:{action:'workspace/packages/rest/getInfo',provider:pv},listeners:{'success':{fn:function(r){this.providerInfos=r.object;Ext.getCmp('modx-package-browser-home').updateDetail(this.providerInfos);},scope:this}}});},setProvider:function(pv){if(Ext.isEmpty(pv)||pv==undefined){pv=MODx.defaultProvider;}
this.getLoader().baseParams.provider=pv;this.getProviderInfos(pv);this.changeGProvider=true;this.changePProvider=true;},onNodeClick:function(n,e){switch(n.attributes.type){case'repository':var r=Ext.getCmp('modx-package-browser-repositories');r.activate();r.updateDetail(n.attributes.data);break;case'tag':var tp=n.parentNode;if(tp&&tp.attributes.data.templated==1){var p=Ext.getCmp('modx-package-browser-thumbs-view');p.store.baseParams.tag=n.attributes.data.id;if(this.changePProvider){p.store.baseParams.provider=MODx.provider;this.changePProvider=false;}
p.run();Ext.getCmp('modx-package-browser-view').activate(n.attributes.data.name);}else{var grid=Ext.getCmp('modx-package-browser-grid');grid.getStore().setBaseParam('tag',n.attributes.data.id);grid.getStore().setBaseParam('query','');if(this.changeGProvider){grid.getStore().setBaseParam('provider',MODx.provider);grid.getStore().removeAll();this.changeGProvider=false;}
grid.getStore().load();grid.activate(n.attributes.data.name);}
break;default:var home=Ext.getCmp('modx-package-browser-home');home.activate();home.updateDetail(this.providerInfos);break;}},onBeforeLoad:function(node){if(node.attributes.type=='repository'){this.loader.baseParams.type='repository';this.loader.baseParams.id=node.attributes.id;}else if(node.attributes.type=='undefined'){this.getSelectionModel().select(this.root.childNodes[0]);}},searchFor:function(name){var f=Ext.getCmp('package-browser-search-fld');f.setValue(name);this.search(f,name);},search:function(tf,newValue){var nv=newValue||tf.originalValue;var grid=Ext.getCmp('modx-package-browser-grid');grid.getStore().setBaseParam('tag','');grid.getStore().setBaseParam('query',nv);grid.getStore().setBaseParam('provider',MODx.provider);grid.getStore().load();grid.activate(_('search'),nv);return true;}});Ext.reg('modx-package-browser-tree',MODx.tree.PackageBrowserTree);;MODx.panel.PackageBrowserHome=function(config){config=config||{};Ext.applyIf(config,{markup:'<tpl for=".">'
+'<div class="one_half"><div class="x-panel-header"><span class="x-panel-header-text">'+_('most_popular')+'</span></div>'
+'<ol class="x-panel-body">'
+'<tpl for="topdownloaded">'
+'<li>'
+'<span class="highlighted">'+_('downloads_view')+'</span>'
+'<button type="button" onclick="Ext.getCmp(\'modx-package-browser-tree\').searchFor(\'{name}\');">'
+'<span class="ct">{#}</span>'
+'{name}'
+'</button>'
+'</li>'
+'</tpl>'
+'</ol>'
+'</div>'
+'<div class="one_half last"><div class="x-panel-header"><span class="x-panel-header-text">'+_('newest_additions')+'</span></div>'
+'<ol class="x-panel-body">'
+'<tpl for="newest">'
+'<li>'
+'<span class="highlighted">{releasedon}</span>'
+'<button type="button" onclick="Ext.getCmp(\'modx-package-browser-tree\').searchFor(\'{package_name}\');">'
+'<span class="ct">{#}</span>'
+'{name}'
+'</button>'
+'</li>'
+'</tpl>'
+'</ol>'
+'</div>'
+'<div class="stats">'
+'<p>'+_('provider_total_packages')+': {packages}</p>'
+'<p>'+_('provider_total_downloads')+': {downloads}</p>'
+'</div>'
+'</tpl>',bodyCssClass:'home-panel'});MODx.panel.PackageBrowserHome.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.PackageBrowserHome,MODx.TemplatePanel,{activate:function(){Ext.getCmp('package-browser-card-container').getLayout().setActiveItem(this.id);var me=this;setTimeout(function(){me.doLayout();},500);}});Ext.reg('modx-package-browser-home',MODx.panel.PackageBrowserHome);MODx.panel.PackageBrowserRepositories=function(config){config=config||{};Ext.applyIf(config,{markup:'<tpl for=".">'
+'<div class="pbr-repository-view">'
+'<h2>{name}</h2>'
+'<p>{description}</p>'
+'</div>'
+'</tpl>',bodyCssClass:'home-panel'});MODx.panel.PackageBrowserRepositories.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.PackageBrowserRepositories,MODx.TemplatePanel,{activate:function(){Ext.getCmp('package-browser-card-container').getLayout().setActiveItem(this.id);}});Ext.reg('modx-package-browser-repositories',MODx.panel.PackageBrowserRepositories);MODx.changeSortComboBox=function(config){config=config||{};Ext.applyIf(config,{store:new Ext.data.ArrayStore({fields:['d','v'],data:[['',''],[_('alphabetically'),'alpha'],[_('most_downloads'),'downloads'],[_('newest_added'),'newest'],[_('top_rated'),'toprated']]}),displayField:'d',valueField:'v',width:280,mode:'local',forceSelection:true,emptyText:_('sort_by_dots'),editable:false,triggerAction:'all',typeAhead:false,selectOnFocus:false});MODx.changeSortComboBox.superclass.constructor.call(this,config);};Ext.extend(MODx.changeSortComboBox,Ext.form.ComboBox);Ext.reg('modx-package-changesort-combobox',MODx.changeSortComboBox);MODx.grid.PackageBrowserGrid=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="package-readme"><i>{description}</i></p>')});this.mainColumnTpl=new Ext.XTemplate('<tpl for=".">'
+'<h3 class="main-column{state:defaultValue("")}">{name}</h3>'
+'<tpl if="actions !== null">'
+'<ul class="actions">'
+'<tpl for="actions">'
+'<li><button type="button" class="controlBtn {className}">{text}</button></li>'
+'</tpl>'
+'</ul>'
+'</tpl>'
+'</tpl>',{compiled:true});Ext.applyIf(config,{id:'modx-package-browser-grid',fields:['id','version','release','signature','author','description','instructions','createdon','editedon','name','downloads','releasedon','screenshot','license','location','version-compiled','supports_db','minimum_supports','breaks_at','featured','audited','changelog','downloaded','dlaction-text','dlaction-icon'],url:MODx.config.connector_url,baseParams:{provider:MODx.provider,action:'workspace/packages/rest/getList'},paging:true,pageSize:10,plugins:[this.exp],showPerPage:false,columns:[this.exp,{header:_('name'),dataIndex:'name',width:100,sortable:true,id:'main',renderer:{fn:this.mainColumnRenderer,scope:this}},{header:_('version'),dataIndex:'version-compiled',width:100,fixed:true,id:'meta-col'},{header:_('author'),dataIndex:'author',width:100,fixed:true,id:'text-col'},{header:_('released'),dataIndex:'releasedon',width:140,fixed:true,id:'info-col'},{header:_('downloads'),dataIndex:'downloads',width:100,fixed:true,id:'text-col'}],tbar:[{xtype:'button',text:_('back_to_manager'),cls:'primary-button',handler:function(){Ext.getCmp('modx-panel-packages').activate();}},'->',{xtype:'modx-package-changesort-combobox',id:'modx-package-grid-changesort-combobox',listeners:{'select':this.changeSort,'change':this.changeSort,scope:this}}]});MODx.grid.PackageBrowserGrid.superclass.constructor.call(this,config);this.on('click',this.onClick,this);};Ext.extend(MODx.grid.PackageBrowserGrid,MODx.grid.Grid,{onClick:function(e){var t=e.getTarget();var elm=t.className.split(' ')[0];if(elm=='controlBtn'){var act=t.className.split(' ')[1];var record=this.getSelectionModel().getSelected();switch(act){case'details':this.onDetails(record.data);break;case'download':this.onDownload(record.data);break;default:break;}}},changeSort:function(cb,rec,idx){var v=cb.getValue();var s=this.getStore();s.removeAll();s.setBaseParam('sorter',v);s.load();},mainColumnRenderer:function(value,metaData,record,rowIndex,colIndex,store){var values={name:value,actions:null};var h=[];h.push({className:'details',text:_('view_details')});if(!record.data.downloaded){h.push({className:'download primary-button',text:_('download')});}
values.actions=h;return this.mainColumnTpl.apply(values);},onDownload:function(rec){var c=Ext.getCmp('modx-panel-packages-browser');c.showWait();Ext.Ajax.request({url:this.config.url,params:{action:'workspace/packages/rest/download',info:rec.location+'::'+rec.signature,provider:MODx.provider},scope:this,success:function(result,request){this.processResult(result.responseText);},failure:function(result,request){Ext.MessageBox.alert(_('failure'),result.responseText);c.hideWait();}});},processResult:function(response){var data=Ext.util.JSON.decode(response);var me=this;if(data.success){me.getStore().reload();Ext.getCmp('modx-package-grid').getStore().reload();Ext.getCmp('modx-panel-packages-browser').hideWait();me.updateBreadcrumbs(_('download_success'),true);setTimeout(function(){me.updateBreadcrumbs(_('list_of_packages_in_provider'));},5000);}
else{Ext.getCmp('modx-panel-packages-browser').hideWait();Ext.MessageBox.alert(_('failure'),data.message);}},onDetails:function(rec){Ext.getCmp('modx-package-browser-details').activate();Ext.getCmp('modx-package-browser-details').updateDetail(rec);},activate:function(cat,query){if(cat!=undefined){this.bdText=cat;}
var msg=(!Ext.isEmpty(query)&&!Ext.isObject(query))?_('search_results_for',{'query':query}):_('packages_in_category');Ext.getCmp('package-browser-card-container').getLayout().setActiveItem(this.id);this.updateBreadcrumbs(msg);},updateBreadcrumbs:function(msg,highlight){var bd={text:msg};if(highlight){bd.className='highlight';}
bd.trail=[{text:_('package_browser'),pnl:'modx-panel-packages-browser'},{text:this.bdText}];Ext.getCmp('packages-breadcrumbs').updateDetail(bd);}});Ext.reg('modx-package-browser-grid',MODx.grid.PackageBrowserGrid);MODx.PackageBrowserWaitWindow=function(config){config=config||{};Ext.applyIf(config,{html:'<p class="wait">'+_('downloading')+'</p>',bodyCssClass:'centered',modal:true,title:_('please_wait'),border:false,closable:false,width:400});MODx.PackageBrowserWaitWindow.superclass.constructor.call(this,config);}
Ext.extend(MODx.PackageBrowserWaitWindow,Ext.Window);MODx.panel.PackageBrowserDetails=function(config){config=config||{};Ext.applyIf(config,{layout:'column',border:false,autoHeight:true,items:[{xtype:'modx-template-panel',id:'modx-package-browser-details-main',columnWidth:1,markup:'<div class="details">'
+'<tpl for=".">'
+'<tpl if="description">'
+'<div class="item">'
+'<h4>'+_('description')+'</h4>'
+'{description}'
+'</div>'
+'</tpl>'
+'<tpl if="instructions">'
+'<div class="item">'
+'<h4>'+_('instructions')+'</h4>'
+'{instructions}'
+'</div>'
+'</tpl>'
+'<tpl if="changelog">'
+'<div class="item">'
+'<h4>'+_('changelog')+'</h4>'
+'{changelog}'
+'</div>'
+'</tpl>'
+'</tpl>'
+'</div>'},{xtype:'modx-template-panel',id:'modx-package-browser-details-aside',cls:'aside-details',width:250,markup:'<div class="details">'
+'<tpl for=".">'
+'<div class="selected">'
+'<tpl if="screenshot">'
+'<a href="{screenshot}" title="'+_('package_preview_view')+'" alt="'+_('package_preview_view')+'" class="lightbox" />'
+'<img src="{screenshot}" alt="{name}" />'
+'</a>'
+'</tpl>'
+'<h5>{name} {version-compiled}</h5>'
+'<tpl if="!downloaded">'
+'<button class="inline-button primary-button" onclick="Ext.getCmp(\'modx-package-browser-details\').downloadPackage(\'{id}\'); return false;"/>'+_('download')+'</button>'
+'</tpl>'
+'<tpl if="downloaded">'
+'<div class="downloaded">'
+_('package_already_downloaded')
+'</div>'
+'</tpl>'
+'</div>'
+'<div class="infos description">'
+'<h4>Information</h4>'
+'<ul>'
+'<li>'
+'<span class="infoname">'+_('author')+':</span>'
+'<span class="infovalue">{author}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('released_on')+':</span>'
+'<span class="infovalue">{releasedon}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('minimum_supports')+':</span>'
+'<span class="infovalue">{minimum_supports:defaultValue("--")}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('breaks_at')+':</span>'
+'<span class="infovalue">{breaks_at:defaultValue("--")}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('supports_db')+':</span>'
+'<span class="infovalue">{supports_db:defaultValue("--")}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('downloads')+':</span>'
+'<span class="infovalue">{downloads}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('license')+':</span>'
+'<span class="infovalue">{license:defaultValue("--")}</span>'
+'</li>'
+'</ul>'
+'</div>'
+'</tpl>'
+'</div>'}],tbar:[{xtype:'button',text:_('back_to_browser'),cls:'primary-button',handler:this.onBackToPackageBrowserGrid,scope:this}]});MODx.panel.PackageBrowserDetails.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.PackageBrowserDetails,MODx.Panel,{activate:function(){Ext.getCmp('package-browser-card-container').getLayout().setActiveItem(this.id);},updateBreadcrumbs:function(msg,highlight){var bd={text:msg};if(highlight){bd.className='highlight';}
bd.trail=[{text:_('package_browser'),pnl:'modx-panel-packages-browser'},{text:_('package_details')}];Ext.getCmp('packages-breadcrumbs').updateDetail(bd);},updateDetail:function(rec,text){this.updateBreadcrumbs(_('package_details')+': '+rec.name+' '+rec['version-compiled']);Ext.getCmp('modx-package-browser-details-main').updateDetail(rec);Ext.getCmp('modx-package-browser-details-aside').updateDetail(rec);},onBackToPackageBrowserGrid:function(btn,e){Ext.getCmp('modx-package-browser-grid').activate();},downloadPackage:function(btn,e){grid=Ext.getCmp('modx-package-browser-grid');var record=grid.getSelectionModel().getSelected();grid.activate();grid.onDownload(record.data);}});Ext.reg('modx-package-browser-details',MODx.panel.PackageBrowserDetails);MODx.PackageBrowserThumbsView=function(config){config=config||{};this._initTemplates();Ext.applyIf(config,{url:MODx.config.connector_url,fields:['id','version','release','signature','author','description','instructions','createdon','editedon','name','downloads','releasedon','screenshot','license','supports','location','version-compiled','downloaded','dlaction-text','dlaction-icon'],baseParams:{action:'workspace/packages/rest/getList',provider:MODx.provider},tpl:this.templates.thumb,listeners:{'dblclick':{fn:this.onDblClick,scope:this}},prepareData:this.formatData.createDelegate(this),overClass:'x-view-over',selectedClass:'selected',itemSelector:'div.thumb-wrapper',loadingText:'<div class="empty-msg"><h4>'+_('loading')+'</h4></div>',emptyText:'<div class="empty-msg">'+this.emptyText+'</div>'||'<div class="empty-msg"><h4>'+_('package_update_err_provider_empty')+'</h4></div>'});MODx.PackageBrowserThumbsView.superclass.constructor.call(this,config);this.on('selectionchange',this.showDetails,this,{buffer:100});};Ext.extend(MODx.PackageBrowserThumbsView,MODx.DataView,{templates:{},run:function(p){var v={};Ext.applyIf(v,this.store.baseParams);Ext.applyIf(v,p);this.store.load({params:v,callback:function(rec,options,success){setTimeout(function(){Ext.getCmp('modx-content').doLayout();},500);}});},sortBy:function(sel){this.store.baseParams.sorter=sel.getValue();this.run();return true;},sortDir:function(sel){this.store.baseParams.dir=sel.getValue();this.run();},showDetails:function(){var selNode=this.getSelectedNodes();if(selNode&&selNode.length>0){selNode=selNode[0];var data=this.lookup[selNode.id];if(data){Ext.getCmp('modx-package-browser-view').updateDetail(data);}}},formatData:function(data){var formatSize=function(data){if(data.size<1024){return data.size+" bytes";}else{return(Math.round(((data.size*10)/1024))/10)+" KB";}};data.shortName=Ext.util.Format.ellipsis(data.name,16);data.sizeString=formatSize(data);data.releasedon=new Date(data.releasedon).format("m/d/Y g:i a");this.lookup['modx-package-thumb-'+data.id]=data;return data;},_initTemplates:function(){this.templates.thumb=new Ext.XTemplate('<tpl for=".">'
+'<div class="thumb-wrapper <tpl if="downloaded">pbr-thumb-downloaded</tpl>" id="modx-package-thumb-{id}">'
+'<div class="thumb">'
+'<tpl if="screenshot.length == 0">'
+'<span class="no-preview">'+_('no_preview')+'</span>'
+'</tpl>'
+'<tpl if="screenshot">'
+'<img src="{screenshot}" title="{name}" alt="{name}" />'
+'</tpl>'
+'</div>'
+'<span class="name">{shortName}</span>'
+'<span class="downloads">{downloads} '+_('downloads')+'</span>'
+'<tpl if="downloaded"><span class="downloaded">'+_('downloaded')+'</span></tpl>'
+'</div>'
+'</tpl>',{compiled:true});},download:function(id){var data=this.lookup['modx-package-thumb-'+id];if(!data)return false;MODx.Ajax.request({url:this.config.url,params:{action:'workspace/packages/rest/download',info:data.location+'::'+data.signature,provider:MODx.provider||MODx.config.default_provider},scope:this,listeners:{'success':{fn:function(r){this.run();},scope:this}}});}});Ext.reg('modx-package-browser-thumbs-view',MODx.PackageBrowserThumbsView);MODx.panel.PackageBrowserView=function(config){config=config||{};this.ident=config.ident||'modx-pkgb-'+Ext.id();this.view=MODx.load({id:'modx-package-browser-thumbs-view',xtype:'modx-package-browser-thumbs-view',containerScroll:true,ident:this.ident,border:false});Ext.applyIf(config,{layout:'column',xtype:'panel',url:MODx.config.connector_url,tbar:[{xtype:'button',text:_('back_to_browser'),handler:function(){Ext.getCmp('modx-panel-packages').activate();}},'->',{xtype:'modx-package-changesort-combobox',id:'modx-package-browser-changesort-combobox',listeners:{'select':function(cb){var v=cb.getValue();var s=Ext.getCmp('modx-package-browser-thumbs-view').getStore();s.removeAll();s.setBaseParam('sorter',v);s.load();}}}],border:false,autoHeight:true,items:[{items:this.view,border:false,bbar:new Ext.PagingToolbar({pageSize:10,store:this.view.store,displayInfo:true,autoLoad:true}),columnWidth:1},{xtype:'modx-template-panel',id:'modx-package-browser-template-aside',cls:'aside-details',width:280,startingText:_('template_select_desc'),markup:'<div class="details">'
+'<tpl for=".">'
+'<div class="selected">'
+'<tpl if="screenshot.length == 0">'
+'<span class="no-preview">'+_('no_preview')+'</span>'
+'</tpl>'
+'<tpl if="screenshot">'
+'<a href="{screenshot}" title="'+_('template_preview_view')+'" alt="'+_('template_preview_view')+'" class="lightbox" />'
+'<img src="{screenshot}" alt="{name}" />'
+'</a>'
+'</tpl>'
+'<h5>{name} {version-compiled}</h5>'
+'<tpl if="!downloaded">'
+'<button class="inline-button green" onclick="Ext.getCmp(\'modx-package-browser-view\').download(\'{id}\'); return false;"/>'+_('download')+'</button>'
+'</tpl>'
+'<tpl if="downloaded">'
+'<div class="downloaded">'
+_('template_already_downloaded')
+'</div>'
+'</tpl>'
+'</div>'
+'<div class="description">'
+'<h4>'+_('description')+'</h4>'
+'{description}'
+'</div>'
+'<div class="infos">'
+'<h4>'+_('information')+'</h4>'
+'<ul>'
+'<li>'
+'<span class="infoname">'+_('author')+':</span>'
+'<span class="infovalue">{author}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('released_on')+':</span>'
+'<span class="infovalue">{releasedon}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('minimum_supports')+':</span>'
+'<span class="infovalue">{supports:defaultValue("--")}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('downloads')+':</span>'
+'<span class="infovalue">{downloads}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('license')+':</span>'
+'<span class="infovalue">{license}</span>'
+'</li>'
+'</ul>'
+'</div>'
+'</tpl>'
+'</div>'}]});MODx.panel.PackageBrowserView.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.PackageBrowserView,MODx.Panel,{activate:function(cat){if(cat!=undefined){this.bdText=cat;}
Ext.getCmp('package-browser-card-container').getLayout().setActiveItem(this.id);this.updateBreadcrumbs(_('viewing_templates_available'));Ext.getCmp('modx-package-browser-template-aside').reset();},updateBreadcrumbs:function(msg,highlight){var bd={text:msg};if(highlight){bd.className='highlight';}
bd.trail=[{text:_('package_browser'),pnl:'modx-panel-packages-browser'},{text:this.bdText}];Ext.getCmp('packages-breadcrumbs').updateDetail(bd);},updateDetail:function(rec){Ext.getCmp('modx-package-browser-template-aside').updateDetail(rec);},download:function(id){var record=this.view.lookup['modx-package-thumb-'+id];var c=Ext.getCmp('modx-panel-packages-browser');if(!record)return false;c.showWait();var me=this;MODx.Ajax.request({url:this.url,params:{action:'workspace/packages/rest/download',info:record.location+'::'+record.signature,provider:MODx.provider||MODx.config.default_provider},scope:this,listeners:{'success':{fn:function(r){this.view.run();c.hideWait();this.updateBreadcrumbs(_('download_success'),true);setTimeout(function(){me.updateBreadcrumbs(_('templates_in_category'));},5000);},scope:this}}});}});Ext.reg('modx-package-browser-view',MODx.panel.PackageBrowserView);;MODx.combo.Provider=function(config){config=config||{};Ext.applyIf(config,{name:'provider',hiddenName:'provider',url:MODx.config.connector_url,baseParams:{action:'workspace/providers/getList',combo:true},editable:false,pageSize:20});MODx.combo.Provider.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.Provider,MODx.combo.ComboBox);Ext.reg('modx-combo-provider',MODx.combo.Provider);MODx.combo.Workspace=function(config){config=config||{};Ext.applyIf(config,{name:'workspace',hiddenName:'workspace',url:MODx.config.connector_url,baseParams:{action:'workspace/getlist'},editable:false,pageSize:20});MODx.combo.Workspace.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.Workspace,MODx.combo.ComboBox);Ext.reg('modx-combo-workspace',MODx.combo.Workspace);;MODx.grid.Package=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.XTemplate('<p class="package-readme"><i>{readme}</i></p>')});this.mainColumnTpl=new Ext.XTemplate('<tpl for=".">'
+'<h3 class="main-column{state:defaultValue("")}">{name}</h3>'
+'<tpl if="actions !== null">'
+'<ul class="actions">'
+'<tpl for="actions">'
+'<li><button type="button" class="controlBtn {className}">{text}</button></li>'
+'</tpl>'
+'</ul>'
+'</tpl>'
+'</tpl>',{compiled:true});var cols=[];cols.push(this.exp);cols.push({header:_('name'),dataIndex:'name',id:'main',renderer:{fn:this.mainColumnRenderer,scope:this}});cols.push({header:_('version'),dataIndex:'version',id:'meta-col',fixed:true,width:120,renderer:function(v,md,record){return v+'-'+record.data.release;}});cols.push({header:_('installed'),dataIndex:'installed',id:'info-col',fixed:true,width:160,renderer:this.dateColumnRenderer});cols.push({header:_('provider'),dataIndex:'provider_name',id:'text-col',fixed:true,width:120});var dlbtn;if(MODx.curlEnabled){dlbtn={text:_('download_extras'),xtype:'splitbutton',cls:'primary-button',handler:this.onDownloadMoreExtra,menu:{items:[{text:_('provider_select'),handler:this.changeProvider,scope:this},{text:_('package_search_local_title'),handler:this.searchLocal,scope:this},{text:_('transport_package_upload'),handler:this.uploadTransportPackage,scope:this}]}};}else{dlbtn={text:_('package_search_local_title'),xtype:'splitbutton',handler:this.searchLocal,scope:this,menu:{items:[{text:_('transport_package_upload'),handler:this.uploadTransportPackage,scope:this}]}};}
Ext.applyIf(config,{title:_('packages'),id:'modx-package-grid',url:MODx.config.connector_url,action:'workspace/packages/getlist',fields:['signature','name','version','release','created','updated','installed','state','workspace','provider','provider_name','disabled','source','attributes','readme','menu','install','textaction','iconaction','updateable'],plugins:[this.exp],pageSize:10,columns:cols,primaryKey:'signature',paging:true,autosave:true,tbar:[dlbtn,'->',{xtype:'textfield',name:'search',id:'modx-package-search',cls:'x-form-filter',emptyText:_('search_ellipsis'),listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(pnl){new Ext.KeyMap(pnl.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:pnl});},scope:this}}},{xtype:'button',id:'modx-package-filter-clear',cls:'x-form-filter-clear',text:_('filter_clear'),listeners:{'click':{fn:this.clearFilter,scope:this}}}]});MODx.grid.Package.superclass.constructor.call(this,config);this.on('render',function(){this.getView().mainBody.update('<div class="x-grid-empty">'+_('loading')+'</div>');},this);this.on('click',this.onClick,this);};Ext.extend(MODx.grid.Package,MODx.grid.Grid,{console:null,activate:function(){var west=Ext.getCmp('modx-leftbar-tabs'),stateId='modx-leftbar-tabs';if(west&&west.stateId){stateId=west.stateId;}
var state=Ext.state.Manager.get(stateId);if(state&&state.collapsed===false){Ext.getCmp('modx-layout').showLeftbar();}
Ext.getCmp('modx-panel-packages').getLayout().setActiveItem(this.id);this.updateBreadcrumbs(_('packages_desc'));},updateBreadcrumbs:function(msg,highlight){msg=Ext.getCmp('packages-breadcrumbs').desc;if(highlight){msg.text=msg;msg.className='highlight';}
Ext.getCmp('packages-breadcrumbs').reset(msg);},search:function(tf,newValue,oldValue){var nv=newValue||tf;this.getStore().baseParams.search=Ext.isEmpty(nv)||Ext.isObject(nv)?'':nv;this.getBottomToolbar().changePage(1);this.refresh();return true;},clearFilter:function(){this.getStore().baseParams={action:'workspace/packages/getList'};Ext.getCmp('modx-package-search').reset();this.getBottomToolbar().changePage(1);this.refresh();},mainColumnRenderer:function(value,metaData,record,rowIndex,colIndex,store){var rec=record.data;var state=(rec.installed!==null)?' installed':' not-installed';var values={name:value,state:state,actions:null};var h=[];if(rec.installed!==null){h.push({className:'uninstall',text:rec.textaction});h.push({className:'reinstall',text:_('package_reinstall_action_button')});}else{h.push({className:'install primary-button',text:rec.textaction});}
if(rec.updateable){h.push({className:'update orange',text:_('package_update_action_button')});}else{if(rec.provider!=0){h.push({className:'checkupdate',text:_('package_check_for_updates')});}}
h.push({className:'remove',text:_('package_remove_action_button')});h.push({className:'details',text:_('view_details')});values.actions=h;return this.mainColumnTpl.apply(values);},dateColumnRenderer:function(d,c){switch(d){case'':case null:c.css='not-installed';return _('not_installed');default:c.css='';return _('installed_on',{'time':d});}},onClick:function(e){var t=e.getTarget();var elm=t.className.split(' ')[0];if(elm=='controlBtn'){var act=t.className.split(' ')[1];var record=this.getSelectionModel().getSelected();this.menu.record=record.data;switch(act){case'remove':this.remove(record,e);break;case'install':case'reinstall':this.install(record);break;case'uninstall':this.uninstall(record,e);break;case'update':case'checkupdate':this.update(record,e);break;case'details':this.viewPackage(record,e);break;default:break;}}},install:function(record){Ext.Ajax.request({url:MODx.config.connector_url,params:{action:'workspace/packages/getAttribute',attributes:'license,readme,changelog,setup-options',signature:record.data.signature},method:'GET',scope:this,success:function(result,request){this.processResult(result.responseText,record);},failure:function(result,request){Ext.MessageBox.alert(_('failed'),result.responseText);}});},processResult:function(response,record){var data=Ext.util.JSON.decode(response);if(data.object.license!==null&&data.object.readme!==null&&data.object.changelog!==null){p=Ext.getCmp('modx-package-beforeinstall');p.activate();p.updatePanel(data.object,record);}
else if(data.object['setup-options']!==null){Ext.getCmp('modx-panel-packages').onSetupOptions();}else{Ext.getCmp('modx-panel-packages').install();}},onDownloadMoreExtra:function(btn,e){MODx.provider=MODx.defaultProvider;Ext.getCmp('modx-panel-packages-browser').activate();},changeProvider:function(btn,e){this.loadWindow(btn,e,{xtype:'modx-package-changeprovider'});},uploadTransportPackage:function(btn,e){if(!this.uploader){this.uploader=new MODx.util.MultiUploadDialog.Dialog({url:MODx.config.connector_url,base_params:{action:'workspace/packages/upload',wctx:MODx.ctx||'',source:MODx.config.default_media_source,path:MODx.config.core_path+'packages/'},permitted_extensions:['zip'],cls:'ext-ux-uploaddialog-dialog modx-upload-window'});this.uploader.on('hide',function(){this.searchLocalWithoutPrompt();},this);this.uploader.on('close',function(){this.searchLocalWithoutPrompt();},this);}
this.uploader.base_params.source=1;this.uploader.show(btn);},searchLocal:function(){MODx.msg.confirm({title:_('package_search_local_title'),text:_('package_search_local_confirm'),url:MODx.config.connector_url,params:{action:'workspace/packages/scanLocal'},listeners:{'success':{fn:function(r){this.getStore().reload();},scope:this}}});},searchLocalWithoutPrompt:function(){MODx.Ajax.request({url:MODx.config.connector_url,params:{action:'workspace/packages/scanLocal'},listeners:{'success':{fn:function(r){this.getStore().reload();},scope:this}}})},viewPackage:function(btn,e){MODx.loadPage('workspaces/package/view','signature='+this.menu.record.signature);},update:function(btn,e){MODx.Ajax.request({url:this.config.url,params:{action:'workspace/packages/update-remote',signature:this.menu.record.signature},listeners:{'success':{fn:function(r){this.loadWindow(btn,e,{xtype:'modx-window-package-update',packages:r.object,record:this.menu.record,force:true,listeners:{'success':{fn:function(o){this.refresh();this.menu.record={data:o.a.result.object};this.install(this.menu.record);},scope:this}}});},scope:this},'failure':{fn:function(r){MODx.msg.alert(_('package_update'),r.message);return false;},scope:this}}});},uninstall:function(btn,e){this.loadWindow(btn,e,{xtype:'modx-window-package-uninstall',listeners:{success:{fn:function(va){this._uninstall(this.menu.record,va,btn);},scope:this}}});},_uninstall:function(r,va,btn){r=this.menu.record;va=va||{};var topic='/workspace/package/uninstall/'+r.signature+'/';this.loadConsole(btn,topic);Ext.apply(va,{action:'workspace/packages/uninstall',signature:r.signature,register:'mgr',topic:topic});MODx.Ajax.request({url:this.config.url,params:va,listeners:{'success':{fn:function(r){Ext.Msg.hide();this.refresh();Ext.getCmp('modx-layout').refreshTrees();},scope:this},'failure':{fn:function(r){Ext.Msg.hide();this.refresh();},scope:this}}});},remove:function(btn,e){if(this.destroying){return MODx.grid.Package.superclass.remove.apply(this,arguments);}
var r=this.menu.record;var topic='/workspace/package/remove/'+r.signature+'/';this.loadWindow(btn,e,{xtype:'modx-window-package-remove',record:{signature:r.signature,topic:topic,register:'mgr'}});},loadConsole:function(btn,topic){this.console=MODx.load({xtype:'modx-console',register:'mgr',topic:topic});this.console.show(btn);},getConsole:function(){return this.console;}});Ext.reg('modx-package-grid',MODx.grid.Package);MODx.window.PackageUpdate=function(config){config=config||{};Ext.applyIf(config,{title:_('package_update'),url:MODx.config.connector_url,action:'workspace/packages/rest/download',id:'modx-window-package-update',saveBtnText:_('update'),fields:this.setupOptions(config.packages,config.record)});MODx.window.PackageUpdate.superclass.constructor.call(this,config);this.on('hide',function(){this.destroy();},this);};Ext.extend(MODx.window.PackageUpdate,MODx.Window,{setupOptions:function(ps,rec){var items=[{html:_('package_update_to_version'),border:false},{xtype:'hidden',name:'provider',value:Ext.isDefined(rec.provider)?rec.provider:MODx.provider}];for(var i=0;i<ps.length;i=i+1){var pkg=ps[i];items.push({xtype:'radio',name:'info',boxLabel:pkg.signature,hideLabel:true,description:pkg.description,inputValue:pkg.info,labelSeparator:'',checked:i==0});}
return items;}});Ext.reg('modx-window-package-update',MODx.window.PackageUpdate);;MODx.window.PackageUninstall=function(config){config=config||{};Ext.applyIf(config,{title:_('package_uninstall'),url:MODx.config.connector_url,action:'workspace/packages/uninstall',id:'modx-window-package-uninstall',saveBtnText:_('uninstall'),fields:[{html:_('preexisting_mode_select'),cls:'win-desc panel-desc'},{xtype:'radio',name:'preexisting_mode',fieldLabel:_('preexisting_mode_preserve'),boxLabel:_('preexisting_mode_preserve_desc'),inputValue:0,checked:true},{xtype:'radio',name:'preexisting_mode',fieldLabel:_('preexisting_mode_remove'),boxLabel:_('preexisting_mode_remove_desc'),inputValue:1},{xtype:'radio',name:'preexisting_mode',fieldLabel:_('preexisting_mode_restore'),boxLabel:_('preexisting_mode_restore_desc'),inputValue:2}]});MODx.window.PackageUninstall.superclass.constructor.call(this,config);};Ext.extend(MODx.window.PackageUninstall,MODx.Window,{submit:function(){var va=this.fp.getForm().getValues();this.fireEvent('success',va);this.hide();}});Ext.reg('modx-window-package-uninstall',MODx.window.PackageUninstall);MODx.window.RemovePackage=function(config){config=config||{};Ext.applyIf(config,{title:_('package_remove'),url:MODx.config.connector_url,baseParams:{action:'workspace/packages/uninstall'},defaults:{border:false},fields:[{xtype:'hidden',name:'signature',id:'modx-rpack-signature',value:config.signature},{html:_('package_remove_confirm')},MODx.PanelSpacer,{html:_('package_remove_force_desc'),border:false},{xtype:'xcheckbox',name:'force',boxLabel:_('package_remove_force'),hideLabel:true,id:'modx-rpack-force',labelSeparator:'',inputValue:'true'}],saveBtnText:_('package_remove')});MODx.window.RemovePackage.superclass.constructor.call(this,config);};Ext.extend(MODx.window.RemovePackage,MODx.Window,{submit:function(){var r=this.config.record;if(this.fp.getForm().isValid()){Ext.getCmp('modx-package-grid').loadConsole(Ext.getBody(),r.topic);this.fp.getForm().baseParams={action:'workspace/packages/remove',signature:r.signature,register:'mgr',topic:r.topic,force:Ext.getCmp('modx-rpack-force').getValue()};this.fp.getForm().submit({waitMsg:_('saving'),scope:this,failure:function(frm,a){this.fireEvent('failure',frm,a);var g=Ext.getCmp('modx-package-grid');g.getConsole().fireEvent('complete');g.refresh();Ext.Msg.hide();this.hide();},success:function(frm,a){this.fireEvent('success',{f:frm,a:a});var g=Ext.getCmp('modx-package-grid');g.getConsole().fireEvent('complete');g.refresh();Ext.Msg.hide();this.hide();}});}}});Ext.reg('modx-window-package-remove',MODx.window.RemovePackage);MODx.window.SetupOptions=function(config){config=config||{};Ext.applyIf(config,{title:_('setup_options'),layout:'form',items:[{xtype:'modx-template-panel',id:'modx-setupoptions-panel',bodyCssClass:'win-desc panel-desc',startingMarkup:'<tpl for="."><p>{text}</p></tpl>',startingText:_('setup_options_desc')},{html:'',xtype:'form',bodyCssClass:'inline-form',id:'modx-setupoptions-form'}],buttons:[{text:config.cancelBtnText||_('cancel'),scope:this,handler:function(){this.hide();}},{text:_('package_install'),cls:'primary-button',id:'package-setupoptions-install-btn',handler:this.install,scope:this}]});MODx.window.SetupOptions.superclass.constructor.call(this,config);};Ext.extend(MODx.window.SetupOptions,MODx.Window,{fetch:function(content){Ext.getCmp('modx-setupoptions-form').getForm().getEl().update(content);},install:function(btn,ev){this.hide();var options=Ext.getCmp('modx-setupoptions-form').getForm().getValues();Ext.getCmp('modx-panel-packages').install(options);}});Ext.reg('modx-package-setupoptions',MODx.window.SetupOptions);MODx.window.ChangeProvider=function(config){config=config||{};Ext.applyIf(config,{title:_('provider_select'),width:600,layout:'form',items:[{xtype:'modx-template-panel',id:'modx-cp-panel',bodyCssClass:'win-desc panel-desc',startingMarkup:'<tpl for="."><p>{text}</p></tpl>',startingText:_('provider_select_desc')},{xtype:'form',id:'change-provider-form',border:false,items:[{fieldLabel:_('provider'),xtype:'modx-combo-provider',id:'modx-pdselprov-provider',anchor:'100%',allowBlank:false,baseParams:{action:'workspace/providers/getList',showNone:false}}]}],buttons:[{text:config.cancelBtnText||_('cancel'),scope:this,handler:function(){this.hide();}},{text:_('save_and_go_to_browser'),cls:'primary-button',id:'package-cp-btn',handler:this.submit,scope:this}]});MODx.window.ChangeProvider.superclass.constructor.call(this,config);};Ext.extend(MODx.window.ChangeProvider,Ext.Window,{submit:function(o){var fm=Ext.getCmp('change-provider-form');if(fm.getForm().isValid()){var vs=fm.getForm().getValues();MODx.provider=vs.provider;MODx.providerName=fm.getForm().findField('provider').getRawValue();var tree=Ext.getCmp('modx-package-browser-tree');tree.setProvider(vs.provider);if(tree.rendered){var loader=tree.getLoader();loader.baseParams={action:'workspace/packages/rest/getNodes',provider:vs.provider};loader.load(tree.root);}
MODx.debug('Switching to: '+MODx.provider);this.hide();Ext.getCmp('modx-panel-packages-browser').activate();}}});Ext.reg('modx-package-changeprovider',MODx.window.ChangeProvider);;MODx.panel.PackageMetaPanel=function(config){config=config||{};Ext.applyIf(config,{cls:'vertical-tabs-panel wrapped',items:[]});MODx.panel.PackageMetaPanel.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.PackageMetaPanel,MODx.VerticalTabs,{updatePanel:function(meta){if(meta.changelog!=undefined){this.addTab(_('changelog'),'changelog',meta);}
if(meta.readme!=undefined){this.addTab(_('readme'),'readme',meta);}
if(meta.license!=undefined){this.addTab(_('license'),'license',meta);}
this.setActiveTab(0);Ext.getCmp('modx-content').doLayout();},addTab:function(title,id,data){var tab=this.getItem(id);if(!tab){this.add({title:title,xtype:'modx-template-panel',id:id+'-tab',markup:'{'+id+'}',bodyCssClass:'meta-wrapper',listeners:{afterrender:function(){this.updateDetail(data);}}});}else{tab.updateDetail(data);}}});Ext.reg('modx-package-meta-panel',MODx.panel.PackageMetaPanel);MODx.panel.PackageBeforeInstall=function(config){config=config||{};this.currentCrumbText=_('install');this.setupOptions=null;Ext.applyIf(config,{});MODx.panel.PackageBeforeInstall.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.PackageBeforeInstall,MODx.panel.PackageMetaPanel,{activate:function(){Ext.getCmp(this.ownerCt.id).getLayout().setActiveItem(this.id);this.removeAll();},updateBreadcrumbs:function(msg){var bd={text:msg};bd.trail=[{text:this.currentCrumbText}];Ext.getCmp('packages-breadcrumbs').updateDetail(bd);},updatePanel:function(meta){this.updateBreadcrumbs(_('license_agreement_desc'));Ext.getCmp('package-list-reset').show();Ext.getCmp('package-install-btn').hide();Ext.getCmp('package-show-setupoptions-btn').hide();if(meta.changelog!=undefined){this.addTab(_('changelog'),'changelog',meta);}
if(meta.readme!=undefined){this.addTab(_('readme'),'readme',meta);}
if(meta.license!=undefined){this.addTab(_('license'),'license',meta);}
if(meta['setup-options']!=null&&meta['setup-options']!=''){Ext.getCmp('package-show-setupoptions-btn').show();this.setupOptions=meta['setup-options'];}else{Ext.getCmp('package-install-btn').show();}
this.setActiveTab(0);Ext.getCmp('modx-content').doLayout();},getOptions:function(){return this.setupOptions;}});Ext.reg('modx-package-beforeinstall',MODx.panel.PackageBeforeInstall);MODx.panel.PackageDetails=function(config){config=config||{};Ext.applyIf(config,{layout:'column',border:false,autoHeight:true,items:[{xtype:'modx-template-panel',id:'modx-package-details-metas',columnWidth:1,markup:'<div class="details">'
+'<tpl for=".">'
+'<tpl if="readme">'
+'<div class="item">'
+'<h4>'+_('readme')+'</h4>'
+'{readme}'
+'</div>'
+'</tpl>'
+'<tpl if="changelog">'
+'<div class="item">'
+'<h4>'+_('changelog')+'</h4>'
+'{changelog}'
+'</div>'
+'</tpl>'
+'<tpl if="license">'
+'<div class="item">'
+'<h4>'+_('license')+'</h4>'
+'{license}'
+'</div>'
+'</tpl>'
+'</tpl>'
+'</div>'},{xtype:'modx-template-panel',id:'modx-package-details-aside',cls:'aside-details',width:250,markup:'<div class="details">'
+'<tpl for=".">'
+'<div class="selected">'
+'<h5>{package_name}</h5>'
+'</div>'
+'<div class="infos description">'
+'<h4>'+_('information')+'</h4>'
+'<ul>'
+'<li>'
+'<span class="infoname">'+_('signature')+':</span>'
+'<span class="infovalue">{signature}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('uploaded_on')+':</span>'
+'<span class="infovalue">{created}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('installed')+':</span>'
+'<span class="infovalue">{installed}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('last_updated')+':</span>'
+'<span class="infovalue">{updated}</span>'
+'</li>'
+'<li>'
+'<span class="infoname">'+_('provider')+':</span>'
+'<span class="infovalue">{provider}</span>'
+'</li>'
+'</ul>'
+'</div>'
+'</tpl>'
+'</div>'}]});MODx.panel.PackageDetails.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.PackageDetails,MODx.Panel,{activate:function(){Ext.getCmp(this.ownerCt.id).getLayout().setActiveItem(this.id);},updateBreadcrumbs:function(msg){Ext.getCmp('packages-breadcrumbs').updateDetail({text:msg,trail:[{text:_('package_details')}]});},updateDetail:function(rec){this.updateBreadcrumbs(_('package_details_for',{'package':rec.package_name}));Ext.getCmp('modx-package-details-metas').updateDetail(rec);Ext.getCmp('modx-package-details-aside').updateDetail(rec);}});Ext.reg('modx-package-details',MODx.panel.PackageDetails);;MODx.panel.Packages=function(config){config=config||{};Ext.applyIf(config,{layout:'card',border:false,layoutConfig:{deferredRender:true},defaults:{autoHeight:true,autoWidth:true,border:false},activeItem:0,items:[{xtype:'modx-package-grid',id:'modx-package-grid',bodyCssClass:'grid-with-buttons'},{xtype:'modx-package-beforeinstall',id:'modx-package-beforeinstall'},{xtype:'modx-package-details',id:'modx-package-details',bodyCssClass:'modx-template-detail'}],buttons:[{text:_('cancel'),id:'package-list-reset',hidden:true,handler:function(btn,e){Ext.getCmp('modx-panel-packages').activate();},scope:this},{text:_('continue'),id:'package-install-btn',cls:'primary-button',hidden:true,handler:this.install,scope:this},{text:_('setup_options'),id:'package-show-setupoptions-btn',cls:'primary-button',hidden:true,handler:this.onSetupOptions,scope:this}]});MODx.panel.Packages.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.Packages,MODx.Panel,{activate:function(){Ext.getCmp('card-container').getLayout().setActiveItem(this.id);Ext.getCmp('modx-package-grid').activate();Ext.each(this.buttons,function(btn){Ext.getCmp(btn.id).hide();});},install:function(va){var g=Ext.getCmp('modx-package-grid');if(!g)return false;var r=g.menu.record.data?g.menu.record.data:g.menu.record;var topic='/workspace/package/install/'+r.signature+'/';g.loadConsole(Ext.getBody(),topic);va=va||{};Ext.apply(va,{action:'workspace/packages/install',signature:r.signature,register:'mgr',topic:topic});MODx.Ajax.request({url:MODx.config.connector_url,params:va,listeners:{'success':{fn:function(){this.activate();Ext.getCmp('modx-package-grid').refresh();},scope:this},'failure':{fn:function(){this.activate();},scope:this}}});},onSetupOptions:function(btn){if(this.win==undefined){this.win=new MODx.window.SetupOptions({id:'modx-window-setupoptions'});}
this.win.show(btn);var opts=Ext.getCmp('modx-package-beforeinstall').getOptions();this.win.fetch(opts);}});Ext.reg('modx-panel-packages',MODx.panel.Packages);MODx.panel.PackagesBrowser=function(config){config=config||{};Ext.applyIf(config,{layout:'column',border:false,items:[{xtype:'modx-package-browser-tree',id:'modx-package-browser-tree',width:250},{layout:'card',columnWidth:1,defaults:{border:false},border:false,id:'package-browser-card-container',layoutConfig:{deferredRender:true},items:[{xtype:'modx-package-browser-home',id:'modx-package-browser-home'},{xtype:'modx-package-browser-repositories',id:'modx-package-browser-repositories'},{xtype:'modx-package-browser-grid',id:'modx-package-browser-grid',bodyCssClass:'grid-with-buttons'},{xtype:'modx-package-browser-details',id:'modx-package-browser-details',bodyCssClass:'modx-template-detail'},{xtype:'modx-package-browser-view',id:'modx-package-browser-view',bodyCssClass:'modx-template-detail'}]}]});MODx.panel.PackagesBrowser.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.PackagesBrowser,MODx.Panel,{activate:function(){Ext.getCmp('modx-layout').hideLeftbar(true,false);Ext.getCmp('card-container').getLayout().setActiveItem(this.id);Ext.getCmp('modx-package-browser-home').activate();this.updateBreadcrumbs(_('provider_home_msg'));},updateBreadcrumbs:function(msg,highlight){var bd={text:msg};if(highlight){bd.className='highlight';}
bd.trail=[{text:_('package_browser')}];Ext.getCmp('packages-breadcrumbs').updateDetail(bd);},showWait:function(){if(typeof(this.wait)=="undefined"){this.wait=new MODx.PackageBrowserWaitWindow();}
this.wait.show();},hideWait:function(){this.wait.hide();}});Ext.reg('modx-panel-packages-browser',MODx.panel.PackagesBrowser);;MODx.grid.Provider=function(config){config=config||{};Ext.applyIf(config,{title:_('providers'),url:MODx.config.connector_url,save_action:'workspace/providers/updatefromgrid',baseParams:{action:'workspace/providers/getlist'},fields:['id','name','description','service_url','username','api_key','menu'],paging:true,autosave:true,columns:[{header:_('name'),dataIndex:'name',editor:{xtype:'textfield',allowBlank:false}},{header:_('service_url'),dataIndex:'service_url',width:200,editor:{xtype:'textfield',allowBlank:false}},{header:_('description'),dataIndex:'description',width:300,editor:{xtype:'textarea'}}],tbar:[{text:_('provider_add'),cls:'primary-button',handler:{xtype:'modx-window-provider-create',blankValues:true}}]});MODx.grid.Provider.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.Provider,MODx.grid.Grid);Ext.reg('modx-grid-provider',MODx.grid.Provider);MODx.window.CreateProvider=function(config){config=config||{};Ext.applyIf(config,{title:_('provider_add'),url:MODx.config.connector_url,action:'workspace/providers/create',fields:[{name:'id',xtype:'hidden'},{fieldLabel:_('name'),name:'name',xtype:'textfield',anchor:'100%',allowBlank:false},{fieldLabel:_('service_url'),name:'service_url',xtype:'textfield',anchor:'100%',allowBlank:false},{fieldLabel:_('username'),name:'username',xtype:'textfield',anchor:'100%'},{fieldLabel:_('api_key'),name:'api_key',xtype:'textfield',anchor:'100%'},{fieldLabel:_('description'),name:'description',xtype:'textarea',anchor:'100%',grow:true}]});MODx.window.CreateProvider.superclass.constructor.call(this,config);};Ext.extend(MODx.window.CreateProvider,MODx.Window);Ext.reg('modx-window-provider-create',MODx.window.CreateProvider);MODx.window.UpdateProvider=function(config){config=config||{};Ext.applyIf(config,{title:_('provider_update'),action:'workspace/providers/update'});MODx.window.UpdateProvider.superclass.constructor.call(this,config);};Ext.extend(MODx.window.UpdateProvider,MODx.window.CreateProvider);Ext.reg('modx-window-provider-update',MODx.window.UpdateProvider);;MODx.panel.Workspace=function(config){config=config||{};Ext.applyIf(config,{id:'modx-panel-workspace',cls:'container',bodyStyle:'',unstyled:true,items:this.getItems(config)});MODx.panel.Workspace.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.Workspace,MODx.Panel,{getItems:function(config){var i=[{html:'<h2>'+_('package_management')+'</h2>',border:false,cls:'modx-page-header',id:'modx-workspace-header'}];if(MODx.errors.length>0){var errors=[];Ext.each(MODx.errors,function(error){errors.push('<p>'+error+'</p>')});errors.join('<hr>');i.push([{html:'<h3>'+_('warning')+'</h3>'+errors,cls:'modx-page-header'}]);}
i.push([MODx.getPageStructure([{title:_('packages'),items:[{xtype:'modx-breadcrumbs-panel',id:'packages-breadcrumbs',desc:_('packages_desc'),root:{text:'Packages List',className:'first',root:true,pnl:'modx-panel-packages'}},{layout:'card',id:'card-container',activeItem:0,border:false,autoHeight:true,defaults:{cls:'main-wrapper',preventRender:true,autoHeight:true},items:[{xtype:'modx-panel-packages',id:'modx-panel-packages'},{xtype:'modx-panel-packages-browser',id:'modx-panel-packages-browser'}]}]},{title:_('providers'),autoHeight:true,layout:'form',items:[{html:'<p>'+_('providers_desc')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-provider',id:'modx-grid-provider',cls:'main-wrapper',title:'',preventRender:true}]}])]);return i;}});Ext.reg('modx-panel-workspace',MODx.panel.Workspace);;Ext.ns('Ext.ux');Ext.ux.Lightbox=(function(){var els={},images=[],activeImage,initialized=false,selectors=[];return{overlayOpacity:0.85,animate:true,resizeSpeed:8,borderSize:10,labelImage:"Image",labelOf:"of",init:function(){this.resizeDuration=this.animate?((11-this.resizeSpeed)*0.15):0;this.overlayDuration=this.animate?0.2:0;if(!initialized){Ext.apply(this,Ext.util.Observable.prototype);Ext.util.Observable.constructor.call(this);this.addEvents('open','close');this.initMarkup();this.initEvents();initialized=true;}},initMarkup:function(){els.shim=Ext.DomHelper.append(document.body,{tag:'iframe',id:'ux-lightbox-shim'},true);els.overlay=Ext.DomHelper.append(document.body,{id:'ux-lightbox-overlay'},true);var lightboxTpl=new Ext.Template(this.getTemplate());els.lightbox=lightboxTpl.append(document.body,{},true);var ids=['outerImageContainer','imageContainer','image','hoverNav','navPrev','navNext','loading','loadingLink','outerDataContainer','dataContainer','data','details','caption','imageNumber','bottomNav','navClose'];Ext.each(ids,function(id){els[id]=Ext.get('ux-lightbox-'+id);});Ext.each([els.overlay,els.lightbox,els.shim],function(el){el.setVisibilityMode(Ext.Element.DISPLAY)
el.hide();});var size=(this.animate?250:1)+'px';els.outerImageContainer.setStyle({width:size,height:size});},getTemplate:function(){return['<div id="ux-lightbox">','<div id="ux-lightbox-outerImageContainer">','<div id="ux-lightbox-imageContainer">','<img id="ux-lightbox-image">','<div id="ux-lightbox-hoverNav">','<a href="#" id="ux-lightbox-navPrev"></a>','<a href="#" id="ux-lightbox-navNext"></a>','</div>','<div id="ux-lightbox-loading">','<a id="ux-lightbox-loadingLink"></a>','</div>','</div>','</div>','<div id="ux-lightbox-outerDataContainer">','<div id="ux-lightbox-dataContainer">','<div id="ux-lightbox-data">','<div id="ux-lightbox-details">','<span id="ux-lightbox-caption"></span>','<span id="ux-lightbox-imageNumber"></span>','</div>','<div id="ux-lightbox-bottomNav">','<a href="#" id="ux-lightbox-navClose"></a>','</div>','</div>','</div>','</div>','</div>'];},initEvents:function(){var close=function(ev){ev.preventDefault();this.close();};els.overlay.on('click',close,this);els.loadingLink.on('click',close,this);els.navClose.on('click',close,this);els.lightbox.on('click',function(ev){if(ev.getTarget().id=='ux-lightbox'){this.close();}},this);els.navPrev.on('click',function(ev){ev.preventDefault();this.setImage(activeImage-1);},this);els.navNext.on('click',function(ev){ev.preventDefault();this.setImage(activeImage+1);},this);},register:function(sel,group){if(selectors.indexOf(sel)===-1){selectors.push(sel);Ext.fly(document).on('click',function(ev){var target=ev.getTarget(sel);if(target){ev.preventDefault();this.open(target,sel,group);}},this);}},open:function(image,sel,group){group=group||false;this.setViewSize();els.overlay.fadeIn({duration:this.overlayDuration,endOpacity:this.overlayOpacity,callback:function(){images=[];var index=0;if(!group){images.push([image.href,image.title]);}
else{var setItems=Ext.query(sel);Ext.each(setItems,function(item){if(item.href){images.push([item.href,item.title]);}});while(images[index][0]!=image.href){index++;}}
var pageScroll=Ext.fly(document).getScroll();var lightboxTop=pageScroll.top+(Ext.lib.Dom.getViewportHeight()/10);var lightboxLeft=pageScroll.left;els.lightbox.setStyle({top:lightboxTop+'px',left:lightboxLeft+'px'}).show();this.setImage(index);this.fireEvent('open',images[index]);},scope:this});},setViewSize:function(){var viewSize=this.getViewSize();els.overlay.setStyle({width:viewSize[0]+'px',height:viewSize[1]+'px'});els.shim.setStyle({width:viewSize[0]+'px',height:viewSize[1]+'px'}).show();},setImage:function(index){activeImage=index;this.disableKeyNav();if(this.animate){els.loading.show();}
els.image.hide();els.hoverNav.hide();els.navPrev.hide();els.navNext.hide();els.dataContainer.setOpacity(0.0001);els.imageNumber.hide();var preload=new Image();preload.onload=(function(){var viewSize=Ext.getBody().getViewSize();var dim=this.scaleSize(viewSize.width,viewSize.height,preload.width,preload.height);els.image.setWidth(dim[0]);els.image.setHeight(dim[1]);els.image.dom.src=images[activeImage][0];this.resizeImage(els.image.dom.width,els.image.dom.height);}).createDelegate(this);preload.src=images[activeImage][0];},scaleSize:function(maxWidth,maxHeight,width,height){var ratio=0;maxHeight=maxHeight-200;if(width>maxWidth){ratio=maxWidth/width;width=maxWidth;height=height*ratio;}
if(height>(maxHeight)){ratio=maxHeight/height;width=width*ratio;height=maxHeight;}
return[width,height];},resizeImage:function(w,h){var wCur=els.outerImageContainer.getWidth();var hCur=els.outerImageContainer.getHeight();var wNew=(w+this.borderSize*2);var hNew=(h+this.borderSize*2);var wDiff=wCur-wNew;var hDiff=hCur-hNew;var afterResize=function(){els.hoverNav.setWidth(els.imageContainer.getWidth()+'px');els.navPrev.setHeight(h+'px');els.navNext.setHeight(h+'px');els.outerDataContainer.setWidth(wNew+'px');this.showImage();};if(hDiff!=0||wDiff!=0){els.outerImageContainer.shift({height:hNew,width:wNew,duration:this.resizeDuration,scope:this,callback:afterResize,delay:50});}
else{afterResize.call(this);}},showImage:function(){els.loading.hide();els.image.fadeIn({duration:this.resizeDuration,scope:this,callback:function(){this.updateDetails();}});this.preloadImages();},updateDetails:function(){var detailsWidth=els.data.getWidth(true)-els.navClose.getWidth()-10;els.details.setWidth((detailsWidth>0?detailsWidth:0)+'px');els.caption.update(images[activeImage][1]);els.caption.show();if(images.length>1){els.imageNumber.update(this.labelImage+' '+(activeImage+1)+' '+this.labelOf+'  '+images.length);els.imageNumber.show();}
els.dataContainer.fadeIn({duration:this.resizeDuration/2,scope:this,callback:function(){var viewSize=this.getViewSize();els.overlay.setHeight(viewSize[1]+'px');this.updateNav();}});},updateNav:function(){this.enableKeyNav();els.hoverNav.show();if(activeImage>0)
els.navPrev.show();if(activeImage<(images.length-1))
els.navNext.show();},enableKeyNav:function(){Ext.fly(document).on('keydown',this.keyNavAction,this);},disableKeyNav:function(){Ext.fly(document).un('keydown',this.keyNavAction,this);},keyNavAction:function(ev){var keyCode=ev.getKey();if(keyCode==88||keyCode==67||keyCode==27){this.close();}
else if(keyCode==80||keyCode==37){if(activeImage!=0){this.setImage(activeImage-1);}}
else if(keyCode==78||keyCode==39){if(activeImage!=(images.length-1)){this.setImage(activeImage+1);}}},preloadImages:function(){var next,prev;if(images.length>activeImage+1){next=new Image();next.src=images[activeImage+1][0];}
if(activeImage>0){prev=new Image();prev.src=images[activeImage-1][0];}},close:function(){this.disableKeyNav();els.lightbox.hide();els.overlay.fadeOut({duration:this.overlayDuration});els.shim.hide();this.fireEvent('close',activeImage);},getViewSize:function(){return[Ext.lib.Dom.getViewWidth(),Ext.lib.Dom.getViewHeight()];}}})();Ext.onReady(Ext.ux.Lightbox.init,Ext.ux.Lightbox);